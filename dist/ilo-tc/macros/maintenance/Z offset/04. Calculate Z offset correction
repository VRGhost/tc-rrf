

if !exists(global.measured_z_height)
    abort "You must 'Set Real Z offset' first"

var z_idx = -1
;----- find_axis_id("Z", var.z_idx)

var axis_iter_10 = 0
var find_success_11 = 0 ; 0 - not found, 1 - found

while var.axis_iter_10 < #move.axes
    if move.axes[var.axis_iter_10].letter == "Z"
        set var.find_success_11 = 1
        set var.z_idx = var.axis_iter_10
        break
    set var.axis_iter_10 = var.axis_iter_10 + 1

if var.find_success_11 == 0
    abort "Failed to find Z axis"

;----- find_axis_id("Z", var.z_idx) END

var current_tool_offset = 0;
if state.currentTool >= 0
    ; A tool is selected
    set var.current_tool_offset = tools[state.currentTool].offsets[var.z_idx]

echo "New Tool Z offset is: " ^ (var.current_tool_offset - (global.measured_z_height - move.axes[var.z_idx].userPosition))
