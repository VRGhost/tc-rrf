; tfree{{ tool.id }}.g
; called when tool {{ tool.id }} is freed

{% from '/__macros__/speeds.jinja' import apply_speed_limits -%}

;Drop the bed
G91
G1 Z4 F1000
G90

;Purge nozzle
;M98 P"purge.g"

;Move In
{% set rounded_Y = (tool.park.Y // 20) * 20 -%}
G53 G1 X{{ tool.park.X }} Y{{ rounded_Y - 90 }} F50000
G53 G1 X{{ tool.park.X }} Y{{ rounded_Y - 40 }} F50000
G53 G1 X{{ tool.park.X }} Y{{ rounded_Y - 20 }} F50000

M913 X30 Y30 ; Set the motor current to 30%

G53 G1 X{{ tool.park.X }} Y{{ tool.park.Y }} F5000

M913 X100 Y100 ; Restore the motor current

;Open Coupler
M98 P"/macros/Coupler - Unlock"

;fan off
M106 P{{ tool.fan }} S0

; Restore the global speed limits
{{ apply_speed_limits(speed_limits) }}

;Move Out
G53 G1 X{{ tool.park.X }} Y{{ rounded_Y - 65 }} F50000

