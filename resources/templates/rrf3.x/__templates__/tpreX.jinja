; tpre{{ tool.id }}.g
; called before tool {{ tool.id }} is selected

{% import '__macros__/errors.jinja' as err %}
{% from "__macros__/move.jinja" import avoid_tc_clash %}

; Just in case - take care not to clash with the environment
{{ avoid_tc_clash() }}

M98 P"/sys/usr/reset_tool_offsets.g"
;Unlock Coupler
M98 P"/macros/Coupler - Unlock"

{% set rounded_Y = (tool.park.Y // 20) * 20 -%}

;Move to location
G1 X{{ tool.park.X }} Y{{ rounded_Y - 40 }} F50000
{{ err.abort_on_error("Unable to complete approach step #0 (tool {id})".format(**tool)) }}
G1 X{{ tool.park.X }} Y{{ rounded_Y - 10 }} F50000
{{ err.abort_on_error("Unable to complete approach step #1 (tool {id})".format(**tool)) }}

M913 X60 Y60 ; Set the motor current to 60%

;Collect
G1 X{{ tool.park.X }} Y{{ tool.park.Y }} F2500
{{ err.abort_on_error("Unable to complete approach step #2 (tool {id})".format(**tool)) }}


;Close Coupler
M98 P"/macros/Coupler - Lock"

;WARNING! WARNING! WARNING! WARNING! WARNING! WARNING! WARNING! WARNING! WARNING! WARNING! WARNING! WARNING!
;if you are using non-standard length hotends ensure the bed is lowered enough BEFORE undocking the tool!
G91
G1 Z{{ -2 * tool.offsets.Z }} F1000
G90

M913 X100 Y100 ; Restore the motor current

{% if 'extra_settings' in tool %}
; {{ tool.extra_settings }}
{% for (cmd, params) in tool.extra_settings.items() -%}

{{ cmd }} {{ py.format_gcode_param_str(params, P=tool.id) }}

{% endfor -%}
{% endif %}

;Move Out
G1 X{{ tool.park.X }} Y{{ rounded_Y - 90 }} F4000